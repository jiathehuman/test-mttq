<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQTT Broker Network Dashboard</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .status-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .status-card:hover {
            transform: translateY(-5px);
        }

        .status-card h3 {
            margin-bottom: 15px;
            color: #4a5568;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }

        .broker-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f1f1f1;
        }

        .broker-item:last-child {
            border-bottom: none;
        }

        .broker-info {
            flex: 1;
        }

        .broker-name {
            font-weight: bold;
            color: #2d3748;
        }

        .broker-ip {
            font-size: 0.9em;
            color: #718096;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            display: inline-block;
        }

        .status-online { background-color: #48bb78; }
        .status-offline { background-color: #f56565; }
        .status-error { background-color: #ed8936; }
        .status-unknown { background-color: #a0aec0; }

        .metrics {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }

        .metric {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            flex: 1;
        }

        .metric-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #4a5568;
        }

        .metric-label {
            font-size: 0.8em;
            color: #718096;
            margin-top: 5px;
        }

        .client-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .client-item {
            padding: 8px 0;
            border-bottom: 1px solid #f1f1f1;
            font-size: 0.9em;
        }

        .client-item:last-child {
            border-bottom: none;
        }

        .timestamp {
            text-align: center;
            color: rgba(255,255,255,0.8);
            margin-top: 20px;
            font-size: 0.9em;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 20px;
            color: white;
            font-weight: bold;
            z-index: 1000;
        }

        .connected { background-color: #48bb78; }
        .disconnected { background-color: #f56565; }

        .network-topology {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .topology-diagram {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
            position: relative;
        }

        .broker-node {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin: 10px;
            position: relative;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .primary-broker {
            background: linear-gradient(135deg, #667eea, #764ba2);
            width: 100px;
            height: 100px;
        }

        .backup-broker {
            background: linear-gradient(135deg, #48bb78, #38a169);
        }

        .broker-offline {
            background: linear-gradient(135deg, #f56565, #e53e3e);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .broker-active {
            animation: pulse 2s infinite;
        }

        .error-message {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîó MQTT Broker Network Dashboard</h1>
            <p>Real-time monitoring of hierarchical MQTT broker network</p>
        </div>

        <div class="connection-status" id="connectionStatus">
            <span id="connectionText">Connecting...</span>
        </div>

        <div class="network-topology">
            <h3>Network Topology</h3>
            <div class="topology-diagram" id="topologyDiagram">
                <!-- Topology will be rendered here -->
            </div>
        </div>

        <div class="status-grid">
            <div class="status-card">
                <h3>üñ•Ô∏è Broker Status</h3>
                <div id="brokerList">
                    <!-- Broker status will be populated here -->
                </div>
                <div class="metrics">
                    <div class="metric">
                        <div class="metric-value" id="totalBrokers">0</div>
                        <div class="metric-label">Total Brokers</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="onlineBrokers">0</div>
                        <div class="metric-label">Online</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="offlineBrokers">0</div>
                        <div class="metric-label">Offline</div>
                    </div>
                </div>
            </div>

            <div class="status-card">
                <h3>üë• Client Connections</h3>
                <div class="client-list" id="clientList">
                    <!-- Client connections will be populated here -->
                </div>
                <div class="metrics">
                    <div class="metric">
                        <div class="metric-value" id="totalClients">0</div>
                        <div class="metric-label">Connected Clients</div>
                    </div>
                </div>
            </div>

            <div class="status-card">
                <h3>üìä System Health</h3>
                <div id="systemHealth">
                    <!-- System health metrics will be populated here -->
                </div>
            </div>

            <div class="status-card">
                <h3>üîç TCP Health Checks</h3>
                <div id="tcpHealth">
                    <!-- TCP health check results will be populated here -->
                </div>
            </div>
        </div>

        <div class="timestamp" id="lastUpdate">
            Last updated: Never
        </div>
    </div>

    <script>
        const socket = io();
        let dashboardData = {};

        // Connection status handling
        socket.on('connect', () => {
            updateConnectionStatus(true);
        });

        socket.on('disconnect', () => {
            updateConnectionStatus(false);
        });

        socket.on('dashboard-update', (data) => {
            dashboardData = data;
            updateDashboard(data);
        });

        socket.on('dashboard-error', (error) => {
            showError(error);
        });

        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            const textElement = document.getElementById('connectionText');

            if (connected) {
                statusElement.className = 'connection-status connected';
                textElement.textContent = 'Connected';
            } else {
                statusElement.className = 'connection-status disconnected';
                textElement.textContent = 'Disconnected';
            }
        }

        function updateDashboard(data) {
            updateBrokerStatus(data.brokers, data.tcpHealth);
            updateClientConnections(data.clients);
            updateSystemHealth(data.systemHealth);
            updateTCPHealth(data.tcpHealth);
            updateTopology(data.brokers, data.tcpHealth);
            updateTimestamp(data.lastUpdate);
        }

        function updateBrokerStatus(brokers, tcpHealth) {
            const brokerList = document.getElementById('brokerList');
            let onlineCount = 0;
            let offlineCount = 0;
            let html = '';

            const brokerIds = ['broker1', 'broker2', 'broker3', 'broker4', 'broker5'];

            brokerIds.forEach(brokerId => {
                const broker = brokers[brokerId];
                const tcpStatus = tcpHealth && tcpHealth[brokerId];

                let status = 'unknown';
                let statusText = 'Unknown';

                if (broker) {
                    status = broker.status;
                    statusText = broker.status.charAt(0).toUpperCase() + broker.status.slice(1);
                    if (status === 'online') onlineCount++;
                    else offlineCount++;
                } else if (tcpStatus) {
                    status = tcpStatus.status;
                    statusText = tcpStatus.status.charAt(0).toUpperCase() + tcpStatus.status.slice(1);
                    if (status === 'online') onlineCount++;
                    else offlineCount++;
                } else {
                    offlineCount++;
                }

                const ip = broker?.ip || tcpStatus?.ip || 'Unknown';
                const connections = broker?.connections || 0;
                const uptime = broker?.uptime ? Math.round(broker.uptime) + 's' : 'N/A';

                html += `
                    <div class="broker-item">
                        <div class="broker-info">
                            <div class="broker-name">
                                <span class="status-indicator status-${status}"></span>
                                ${brokerId.toUpperCase()}
                            </div>
                            <div class="broker-ip">${ip} | Connections: ${connections} | Uptime: ${uptime}</div>
                        </div>
                        <div class="broker-status">${statusText}</div>
                    </div>
                `;
            });

            brokerList.innerHTML = html;
            document.getElementById('totalBrokers').textContent = brokerIds.length;
            document.getElementById('onlineBrokers').textContent = onlineCount;
            document.getElementById('offlineBrokers').textContent = offlineCount;
        }

        function updateClientConnections(clients) {
            const clientList = document.getElementById('clientList');
            const clientCount = Object.keys(clients).length;

            let html = '';
            Object.entries(clients).forEach(([clientId, client]) => {
                const lastSeen = new Date(client.last_seen).toLocaleTimeString();
                html += `
                    <div class="client-item">
                        <strong>${clientId}</strong><br>
                        Connected to: ${client.connected_broker || 'Unknown'}<br>
                        Last seen: ${lastSeen}
                    </div>
                `;
            });

            clientList.innerHTML = html || '<div class="client-item">No clients connected</div>';
            document.getElementById('totalClients').textContent = clientCount;
        }

        function updateSystemHealth(health) {
            const healthElement = document.getElementById('systemHealth');

            if (!health) {
                healthElement.innerHTML = '<div>No health data available</div>';
                return;
            }

            const html = `
                <div class="metrics">
                    <div class="metric">
                        <div class="metric-value">${health.active_brokers || 0}</div>
                        <div class="metric-label">Active Brokers</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">${health.connected_clients || 0}</div>
                        <div class="metric-label">Total Clients</div>
                    </div>
                </div>
                <div style="margin-top: 15px; font-size: 0.9em; color: #718096;">
                    Service Status: <strong style="color: #48bb78;">${health.status}</strong>
                </div>
            `;

            healthElement.innerHTML = html;
        }

        function updateTCPHealth(tcpHealth) {
            const tcpElement = document.getElementById('tcpHealth');

            if (!tcpHealth) {
                tcpElement.innerHTML = '<div>No TCP health data available</div>';
                return;
            }

            let html = '';
            Object.entries(tcpHealth).forEach(([brokerId, health]) => {
                const timestamp = new Date(health.timestamp * 1000).toLocaleTimeString();
                html += `
                    <div class="broker-item">
                        <div class="broker-info">
                            <div class="broker-name">
                                <span class="status-indicator status-${health.status}"></span>
                                ${brokerId.toUpperCase()}
                            </div>
                            <div class="broker-ip">${health.ip}:${health.port} | Checked: ${timestamp}</div>
                        </div>
                    </div>
                `;
            });

            tcpElement.innerHTML = html;
        }

        function updateTopology(brokers, tcpHealth) {
            const topologyElement = document.getElementById('topologyDiagram');

            const brokerIds = ['broker1', 'broker2', 'broker3', 'broker4', 'broker5'];
            let html = '';

            brokerIds.forEach((brokerId, index) => {
                const broker = brokers[brokerId];
                const tcpStatus = tcpHealth && tcpHealth[brokerId];

                let status = 'unknown';
                if (broker) {
                    status = broker.status;
                } else if (tcpStatus) {
                    status = tcpStatus.status;
                }

                const isPrimary = index === 0;
                const isActive = status === 'online';

                let nodeClass = 'broker-node ';
                if (isPrimary) {
                    nodeClass += 'primary-broker ';
                } else {
                    nodeClass += status === 'online' ? 'backup-broker ' : 'broker-offline ';
                }

                if (isActive) {
                    nodeClass += 'broker-active ';
                }

                html += `
                    <div class="${nodeClass}" title="${brokerId.toUpperCase()} - ${status}">
                        ${index + 1}
                    </div>
                `;
            });

            topologyElement.innerHTML = html;
        }

        function updateTimestamp(timestamp) {
            const timestampElement = document.getElementById('lastUpdate');
            if (timestamp) {
                const date = new Date(timestamp);
                timestampElement.textContent = `Last updated: ${date.toLocaleString()}`;
            }
        }

        function showError(error) {
            const container = document.querySelector('.container');
            const errorHtml = `
                <div class="error-message">
                    ‚ö†Ô∏è Error: ${error.error}<br>
                    <small>Time: ${new Date(error.timestamp).toLocaleString()}</small>
                </div>
            `;

            // Remove existing error messages
            const existingError = container.querySelector('.error-message');
            if (existingError) {
                existingError.remove();
            }

            // Add new error message
            container.insertAdjacentHTML('afterbegin', errorHtml);

            // Remove error message after 10 seconds
            setTimeout(() => {
                const errorElement = container.querySelector('.error-message');
                if (errorElement) {
                    errorElement.remove();
                }
            }, 10000);
        }

        // Request initial data
        socket.emit('request-update');
    </script>
</body>
</html>